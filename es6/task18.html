<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Title</title>
</head>
<body>
<script>
    // task18_Promises.1: Web crawling

    /*
     There is one page on the domain http://marijnhaverbeke.nl that contains the word “Piranha”.
     It is linked from the domain's top page.

     Given this Promise-returning implementation of an HTTP get request, write a simple promise-based
     “crawler” that first fetches the top page, then uses some crude regexp technique to find linked
     URLs in that page, and fetches all linked local pages, in parallel. It scans the content of those
     pages for the word “Piranha”, and logs the address of any matching pages to the console.
     */

    function get(url) {
        return new Promise((succeed, fail) => {
            let req = new XMLHttpRequest();
            req.open("GET", url, true);
            req.addEventListener("load", () => {
                if (req.status < 400)
                    succeed(req.responseText);
                else
                    fail(new Error("Request failed: " + req.statusText))
            });
            req.addEventListener("error", () => {
                fail(new Error("Network error"))
            });
            req.send(null)
        })
    }
    get('http://marijnhaverbeke.nl').then((text) => {

            const links = text.match(/([a-z0-9_\.-]+)html/gi);

            for (let link of links){
                let url = `http://marijnhaverbeke.nl/${link}`;
                get(url).then(data=>{
                    const text = data.search(/Piranha/gi);
                    if(text != -1) {
                        console.log(url);
                    }
                })
            }
        }
    )
</script>
</body>
</html>